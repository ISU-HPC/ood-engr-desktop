#!/usr/bin/env bash

echo $(pwd)

# Copy resource files to correct locations in users home directory
cp -r "../desktop-directories" "${HOME}/.local/share/"
cp -r "../applications" "${HOME}/.local/share/"
mkdir "${HOME}/.config/menus"
cp "../xfce-applications.menu" "${HOME}/.config/menus/"
mkdir "${HOME}/.icons"
cp "../engrDesktop/*/*.png" "${HOME}/.icons"
cp -r "../engrDesktop" "${HOME}/engrDesktop"

# Edit *changeMe* paths to new engrDesktop directory
sed -i "s#changeMe#$HOME#g" "${HOME}/.local/share/applications/*.desktop"

# Change working directory to user's home directory
cd "${HOME}"

# Reset module environment (may require login shell for some HPC clusters)
module purge && module restore

# Ensure that the user's configured login shell is used
export SHELL="$(getent passwd $USER | cut -d: -f7)"

# Start up desktop
echo "Launching desktop '<%= context.desktop %>'..."
source "<%= session.staged_root.join("desktops", "#{context.desktop}.sh") %>"
echo "Desktop '<%= context.desktop %>' ended..."
